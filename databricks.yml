bundle:
  name: ais-pipelines

workspace:
  root_path: /Users/${workspace.current_user.userName}/.bundle/${bundle.name}/${bundle.target}

variables:
  # Unity Catalog Configuration
  catalog:
    description: "Unity Catalog catalog name"
    default: ais
  
  schema:
    description: "Unity Catalog schema name"
    default: ais_assets
  
  # Volume Configuration
  source_volume:
    description: "Volume containing full history files"
    default: full_history
  
  landing_volume:
    description: "Volume where files are dripped to"
    default: landing
  
  # Dripper Configuration
  dripper_n_per_run:
    description: "Number of files to release per run"
    default: 1
  
  dripper_delete_source:
    description: "Whether to delete source files after copying"
    default: false
  
  # Decompressor Configuration
  decompressor_limit:
    description: "Number of files to decompress per run (0 = all files)"
    default: 0
  
  decompressor_delete_compressed:
    description: "Whether to delete compressed files after decompressing"
    default: false
  
  # Auto Loader Configuration
  autoloader_schema_location:
    description: "Relative path within landing volume for schemas"
    default: _schemas/events
  
  autoloader_checkpoint_location:
    description: "Relative path within landing volume for checkpoints"
    default: _checkpoints/events
  
  autoloader_target_table:
    description: "Target Delta table name"
    default: "${var.catalog}.events_raw"
  
  # Download Configuration
  download_target_volume:
    description: "Volume where AIS files will be downloaded"
    default: full_history
  
  download_year:
    description: "Year to download from NOAA"
    default: 2025
  
  download_limit:
    description: "Maximum number of files to download (0 = all files)"
    default: 1

artifacts:
  # Build your project into a wheel using uv, so the exact env is defined by your pyproject/uv.lock.
  app_wheel:
    type: whl
    path: .
    # `uv build` produces a wheel into ./dist; the job will install that wheel on serverless.
    build: uv build

resources:
  jobs:
    download_ais:
      name: "[${bundle.target}] AIS Downloader"
      tasks:
        - task_key: download_ais
          python_wheel_task:
            package_name: ais_pipelines
            entry_point: download-ais
            parameters:
              - "--catalog"
              - "${var.catalog}"
              - "--schema"
              - "${var.schema}"
              - "--volume"
              - "${var.download_target_volume}"
              - "--year"
              - "${var.download_year}"
              - "--limit"
              - "${var.download_limit}"
          environment_key: default
      environments:
        - environment_key: default
          spec:
            client: "4"
            dependencies:
              - ./dist/*.whl
    
    decompress:
      name: "[${bundle.target}] AIS Decompressor"
      tasks:
        - task_key: decompress_files
          python_wheel_task:
            package_name: ais_pipelines
            entry_point: decompress
            parameters:
              - "--catalog"
              - "${var.catalog}"
              - "--schema"
              - "${var.schema}"
              - "--history-volume"
              - "${var.source_volume}"
              - "--landing-volume"
              - "${var.landing_volume}"
              - "--limit"
              - "${var.decompressor_limit}"
              - "--delete-compressed"
              - "${var.decompressor_delete_compressed}"
          environment_key: default
      environments:
        - environment_key: default
          spec:
            client: "1"
            dependencies:
              - ./dist/*.whl

targets:
  dev:
    default: true
  prod:
    mode: production
