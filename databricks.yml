bundle:
  name: ais-pipelines

workspace:
  root_path: /Users/${workspace.current_user.userName}/.bundle/${bundle.name}/${bundle.target}

variables:
  # Unity Catalog Configuration
  catalog:
    description: "Unity Catalog catalog name"
    default: dbacademy
  
  schema:
    description: "Unity Catalog schema name"
    default: labuser12237744_1761062588
  
  # Volume Configuration
  source_volume:
    description: "Volume containing full history files"
    default: full_history
  
  landing_volume:
    description: "Volume where files are dripped to"
    default: landing
  
  # Dripper Configuration
  dripper_n_per_run:
    description: "Number of files to release per run"
    default: 1
  
  dripper_delete_source:
    description: "Whether to delete source files after copying"
    default: false
  
  # Auto Loader Configuration
  autoloader_schema_location:
    description: "Relative path within landing volume for schemas"
    default: _schemas/events
  
  autoloader_checkpoint_location:
    description: "Relative path within landing volume for checkpoints"
    default: _checkpoints/events
  
  autoloader_target_table:
    description: "Target Delta table name"
    default: "${var.catalog}.events_raw"
  
  # Download Configuration
  download_target_volume:
    description: "Volume where AIS files will be downloaded"
    default: full_history
  
  download_year:
    description: "Year to download from NOAA"
    default: 2025
  
  download_limit:
    description: "Maximum number of files to download (0 = all files)"
    default: 0

artifacts:
  # Build your project into a wheel using uv, so the exact env is defined by your pyproject/uv.lock.
  app_wheel:
    type: whl
    path: .
    # `uv build` produces a wheel into ./dist; the job will install that wheel on serverless.
    build: uv build

resources:
  jobs:
    download_ais_test:
      name: "[${bundle.target}] AIS Download Test"
      tasks:
        - task_key: download_single_file
          python_wheel_task:
            package_name: ais_pipelines
            entry_point: download-ais
            parameters:
              - "--catalog"
              - "${var.catalog}"
              - "--schema"
              - "${var.schema}"
              - "--volume"
              - "${var.download_target_volume}"
              - "--year"
              - "${var.download_year}"
              - "--limit"
              - "${var.download_limit}"
          environment_key: default
      environments:
        - environment_key: default
          spec:
            client: "1"
            dependencies:
              - ./dist/*.whl
    
    dripper:
      name: "[${bundle.target}] AIS Dripper"
      schedule:
        quartz_cron_expression: "0/10 * * * * ?"  # every 10 seconds
        timezone_id: "UTC"
        pause_status: "UNPAUSED"
      tasks:
        - task_key: drip_files
          python_wheel_task:
            package_name: ais_pipelines
            entry_point: dripper
            parameters:
              - "--catalog"
              - "${var.catalog}"
              - "--schema"
              - "${var.schema}"
              - "--source-volume"
              - "${var.source_volume}"
              - "--landing-volume"
              - "${var.landing_volume}"
              - "--n-per-run"
              - "${var.dripper_n_per_run}"
              - "--delete-source"
              - "${var.dripper_delete_source}"
          environment_key: default
      environments:
        - environment_key: default
          spec:
            client: "1"
            dependencies:
              - ./dist/*.whl
    
    autoloader:
      name: "[${bundle.target}] AIS Auto Loader"
      tasks:
        - task_key: stream_files
          python_wheel_task:
            package_name: ais_pipelines
            entry_point: autoloader
            parameters:
              - "--catalog"
              - "${var.catalog}"
              - "--schema"
              - "${var.schema}"
              - "--landing-volume"
              - "${var.landing_volume}"
              - "--schema-location"
              - "${var.autoloader_schema_location}"
              - "--checkpoint-location"
              - "${var.autoloader_checkpoint_location}"
              - "--target-table"
              - "${var.autoloader_target_table}"
          environment_key: default
      environments:
        - environment_key: default
          spec:
            client: "1"
            dependencies:
              - ./dist/*.whl

targets:
  dev:
    default: true
  prod:
    mode: production